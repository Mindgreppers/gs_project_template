summary: Twilio API - Make a Call
tasks:
  - id: make_twilio_call
    description: Get Twilio Call Details
    fn: com.gs.http
    params:
      account_sid: <% config.twilio.TWILIO_ACCOUNT_SID %>
      call_sid: <%inputs.body.CallSid%>
    args:
      datasource: httpbin
      config:
        url: "https://api.twilio.com/2010-04-01/Accounts/<% config.twilio.TWILIO_ACCOUNT_SID %>/Calls/<%inputs.body.CallSid%>.json"
        method: get
        auth:
          username: <% config.twilio.TWILIO_ACCOUNT_SID %>
          password: <% config.twilio.TWILIO_AUTH_TOKEN %>
    retry:
      max_attempts: 5
      type: constant
      interval: PT15M
    on_error:
      continue: false
      tasks:
        - id: failure_res
          fn: com.gs.transform 
          args:
            data:             
              code: <% outputs.make_twilio_call.code %>
              message: <% outputs.make_twilio_call.data.message %>
              success: <% outputs.make_twilio_call.success %>
              more_info: <% outputs.make_twilio_call.data.more_info %>

 
#Invoke the uploadFileToS3 function to upload call detail to the S3 bucket.   
  - id: call_detail
    fn: twilio.uploadFileToS3.uploadFileToS3
    args: |
      <js% 
        {
          return JSON.stringify(outputs.make_twilio_call.data)
        }
      %>
  
  - id: file_start_to_upload_on_s3
    fn: com.gs.transform
    args:
      data:   
        code: <% outputs.call_detail.code %>
        message: 'Start uploading the file to the S3 bucket.'
        success: <% outputs.call_detail.success %>


 # Upload call details as a text file to S3
  # - id: upload_file_to_s3
  #   description: upload call recording file to s3 bucket
  #   fn: com.gs.aws
  #   args:
  #     datasource: aws_s3
  #     params:
  #       - Bucket: <% config.s3_bucket %>
  #         Key: <% inputs.body.CallSid %>.txt
  #         Body: <% outputs.call_detail.data %>
  #     config: 
  #       service: s3
  #       method: putObject
