summary: Twilio API - Make a Call
tasks:
#prepare twilio url
  - id: prepare_twilio_request
    description: prepare twilio request
    fn: com.gs.transform
    args: |
      <js%
        {
          return `${config.twilio.TWILIO_ACCOUNT_SID}/Calls/${inputs.body.CallSid}.json`
        }
      %>

# Fetch call detail from Twilio
  - id: make_twilio_call
    description: Make a call using Twilio API
    fn: com.gs.http
    args:
      datasource: twilio
      config:
        url: <% outputs.prepare_twilio_request.data %>
        method: post
    retry:
      maxAttempt: 5
    on_error:
      continue: false
      tasks:
        - id: failure_res
          fn: com.gs.transform 
          args:
            data:             
              code: <% outputs.make_twilio_call.code %>
              message: <% outputs.make_twilio_call.data.message %>
              success: <% outputs.make_twilio_call.success %>
              more_info: <% outputs.make_twilio_call.data.more_info %>

#Invoke the uploadFileToS3 function to upload call detail to the S3 bucket.   
  - id: call_detail
    fn: twilio.uploadFileToS3.uploadFileToS3
    args: |
      <js% 
        {
          return JSON.stringify(outputs.make_twilio_call.data)
        }
      %>
  
  - id: file_start_to_upload_on_s3
    fn: com.gs.transform
    args:
      data:   
        code: <% outputs.call_detail.code %>
        message: 'Start uploading the file to the S3 bucket.'
        success: <% outputs.call_detail.success %>


 # Upload call details as a text file to S3
  # - id: upload_file_to_s3
  #   description: upload call recording file to s3 bucket
  #   fn: com.gs.aws
  #   args:
  #     datasource: aws_s3
  #     params:
  #       - Bucket: <% config.s3_bucket %>
  #         Key: <% inputs.body.CallSid %>.txt
  #         Body: <% outputs.call_detail.data %>
  #     config: 
  #       service: s3
  #       method: putObject
